<?xml version="1.0" encoding="UTF-8"?>
<blueprint xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xmlns:cm="http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0"
           xmlns="http://www.osgi.org/xmlns/blueprint/v1.0.0"
           xsi:schemaLocation="
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd
       http://aries.apache.org/blueprint/xmlns/blueprint-cm/v1.1.0 http://aries.apache.org/schemas/blueprint-cm/blueprint-cm-1.1.0.xsd">

    <cm:property-placeholder persistent-id="com.garethahealy.camel.activemq.transacted" update-strategy="reload">
        <cm:default-properties>
            <cm:property name="activemq.concurrentConsumers" value="10"/>
        </cm:default-properties>
    </cm:property-placeholder>

    <reference id="amqPooledConnectionFactory" interface="javax.jms.ConnectionFactory"/>

    <bean id="jmsTransactionManager" class="org.springframework.jms.connection.JmsTransactionManager">
        <property name="connectionFactory" ref="amqPooledConnectionFactory"/>
    </bean>

    <bean id="activeMQConfiguration" class="org.apache.activemq.camel.component.ActiveMQConfiguration">
        <property name="connectionFactory" ref="amqPooledConnectionFactory"/>
        <property name="concurrentConsumers" value="${activemq.concurrentConsumers}"/>
        <property name="transactionManager" ref="jmsTransactionManager"/>
        <property name="transacted" value="true"/>
        <property name="cacheLevelName" value="CACHE_CONSUMER"/>
    </bean>

    <bean class="org.apache.activemq.camel.component.ActiveMQComponent" id="activemq">
        <property name="configuration" ref="activeMQConfiguration"/>
    </bean>

    <camelContext id="camel-activemq-transacted-context" trace="false" xmlns="http://camel.apache.org/schema/blueprint">

        <route id="test">
            <from uri="direct:somet"/>
            <to uri="activemq:somet"/>
        </route>

        <!-- mq-create for broker, and then assign to container  -->

    </camelContext>
</blueprint>
